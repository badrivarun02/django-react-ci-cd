name: CI/CD - Build, Push & cloud Deploy

on:
  push:
    branches: [main]

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Build & push Backend
      - name: Build and push Backend image
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/hello-django-backend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # Build & push Frontend
      - name: Build and push Frontend image
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/hello-react-frontend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ────────────────────────────────────────────────
  # Deployment to cloud machine (via self-hosted runner)
  # ────────────────────────────────────────────────
  deploy-cloud:
    needs: build-and-push
    runs-on: self-hosted  # ← This targets your local runner
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code on local runner
        uses: actions/checkout@v4

      - name: Terraform Init & Validate & Plan
        working-directory: ./terraform   # ← CHANGE THIS to your tf folder
        run: |
            terraform init -upgrade
            terraform validate
            terraform fmt -check || echo "Formatting issues found — fix them"
            terraform plan -out=tfplan

      - name: Terraform Apply (auto-approve — use with caution!)
        working-directory: ./terraform
        run: terraform apply -auto-approve tfplan

      - name: Show Terraform Outputs & Access Links
        working-directory: ./terraform
        run: |
            cat << 'EOF' >> "$GITHUB_STEP_SUMMARY"

            ### Deployment Summary

            **Terraform Outputs:**

            | Service     | URL / Info                          |
            |-------------|-------------------------------------|
            | Frontend    | http://$(terraform output -raw public_ip || echo "N/A"):80 |
            |             | (or your domain if set)             |

            > **Note:** If runner is remote, use public IP/domain above — not localhost.

            EOF